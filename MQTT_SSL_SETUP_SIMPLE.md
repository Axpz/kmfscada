# MQTT SSL ç®€åŒ–é…ç½®æŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†ç®€åŒ–çš„MQTT SSLç»ˆç«¯é…ç½®ï¼Œä½¿ç”¨NGINXä»£ç†å®ç°8883ç«¯å£SSLå¸è½½å¹¶è½¬å‘åˆ°RabbitMQçš„1883ç«¯å£ã€‚

## é…ç½®ç‰¹ç‚¹

âœ… **ç®€åŒ–æ¶æ„**: ä½¿ç”¨ä¸“ç”¨NGINXå®¹å™¨æ›¿ä»£å¤æ‚çš„Kongé…ç½®  
âœ… **ç”Ÿäº§å¯ç”¨**: æ”¯æŒTLS 1.2/1.3ï¼Œå®‰å…¨çš„SSL/TLSé…ç½®  
âœ… **æ˜“äºç»´æŠ¤**: å»é™¤å¤æ‚çš„åˆå§‹åŒ–è„šæœ¬ï¼Œé…ç½®æ¸…æ™°ç›´è§‚  
âœ… **è‡ªåŠ¨åŒ–æµ‹è¯•**: å®Œæ•´çš„Makefileå‘½ä»¤æ”¯æŒ  

## æ¶æ„å›¾

```
å®¢æˆ·ç«¯ --[SSL/TLS 8883]--> NGINXä»£ç† --[Plain 1883]--> RabbitMQ MQTT
```

## æ–‡ä»¶ç»“æ„

```
kmfscada/
â”œâ”€â”€ docker-compose.rabbitmq.yml     # RabbitMQ + MQTT SSLä»£ç†é…ç½®
â”œâ”€â”€ volumes/
â”‚   â”œâ”€â”€ api/ssl/                    # SSLè¯ä¹¦ç›®å½•
â”‚   â”‚   â”œâ”€â”€ ca.crt                  # CAæ ¹è¯ä¹¦
â”‚   â”‚   â”œâ”€â”€ ca.key                  # CAç§é’¥
â”‚   â”‚   â”œâ”€â”€ mqtt.crt                # MQTTæœåŠ¡å™¨è¯ä¹¦
â”‚   â”‚   â””â”€â”€ mqtt.key                # MQTTæœåŠ¡å™¨ç§é’¥
â”‚   â””â”€â”€ nginx/
â”‚       â””â”€â”€ mqtt-ssl.conf           # NGINXé…ç½®æ–‡ä»¶
â””â”€â”€ scripts/
    â””â”€â”€ test_mqtt_ssl_simple.py     # æµ‹è¯•è„šæœ¬
```

## æ ¸å¿ƒé…ç½®

### 1. NGINXé…ç½® (`volumes/nginx/mqtt-ssl.conf`)

```nginx
stream {
    upstream mqtt_backend {
        server rabbitmq:1883;
    }
    
    server {
        listen 8883 ssl;
        proxy_pass mqtt_backend;
        
        ssl_certificate /etc/nginx/ssl/mqtt.crt;
        ssl_certificate_key /etc/nginx/ssl/mqtt.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        # ... å…¶ä»–SSLé…ç½®
    }
}
```

### 2. Docker Composeé…ç½® (`docker-compose.rabbitmq.yml`)

```yaml
services:
  rabbitmq:
    # RabbitMQé…ç½®...
    
  mqtt-ssl-proxy:
    image: nginx:alpine
    container_name: mqtt-ssl-proxy
    ports:
      - "8883:8883"
    volumes:
      - ./volumes/api/ssl:/etc/nginx/ssl:ro
      - ./volumes/nginx/mqtt-ssl.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - rabbitmq
```

## ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿå¯åŠ¨

```bash
# ä¸€é”®è®¾ç½®å’Œæµ‹è¯•
make mqtt-ssl-setup

# æˆ–åˆ†æ­¥æ“ä½œ
make mqtt-ssl    # å¯åŠ¨æœåŠ¡
make test-mqtt-ssl  # è¿è¡Œæµ‹è¯•
make mqtt-ssl-down  # åœæ­¢æœåŠ¡
```

### å¯ç”¨å‘½ä»¤

| å‘½ä»¤ | æè¿° |
|------|------|
| `make mqtt-ssl-setup` | å®Œæ•´è®¾ç½®å’Œæµ‹è¯•ï¼ˆæ¨èï¼‰ |
| `make mqtt-ssl` | å¯åŠ¨MQTT SSLä»£ç† |
| `make mqtt-ssl-down` | åœæ­¢MQTT SSLä»£ç† |
| `make mqtt-ssl-logs` | æŸ¥çœ‹ä»£ç†æ—¥å¿— |
| `make test-mqtt-ssl` | è¿è¡Œç®€å•æµ‹è¯• |
| `make test-mqtt-ssl-full` | è¿è¡Œå®Œæ•´æµ‹è¯• |

## æµ‹è¯•ç»“æœ

æˆåŠŸè¿è¡Œåï¼Œæ‚¨å°†çœ‹åˆ°ï¼š

```
ğŸ§ª MQTT SSLä»£ç†æµ‹è¯•
==================================================

1. æµ‹è¯•RabbitMQ MQTTæœåŠ¡:
âœ… æ™®é€šMQTTè¿æ¥æˆåŠŸ

2. æµ‹è¯•Kong SSLä»£ç†:
âœ… SSLè¿æ¥æˆåŠŸ
   åè®®ç‰ˆæœ¬: TLSv1.3
   åŠ å¯†å¥—ä»¶: ('TLS_AES_256_GCM_SHA384', 'TLSv1.3', 256)
âœ… MQTTè¿æ¥å»ºç«‹æˆåŠŸ

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼MQTT SSLä»£ç†é…ç½®æ­£ç¡®ã€‚
```

## è¿æ¥å‚æ•°

- **SSLç«¯å£**: 8883
- **åè®®**: MQTT 3.1.1 over SSL/TLS
- **è®¤è¯**: ç”¨æˆ·å `admin`, å¯†ç  `admin123`
- **æ”¯æŒçš„TLSç‰ˆæœ¬**: TLS 1.2, TLS 1.3

## è¯ä¹¦ç®¡ç†

SSLè¯ä¹¦è‡ªåŠ¨ç”Ÿæˆï¼Œæœ‰æ•ˆæœŸ365å¤©ã€‚å¦‚éœ€æ›´æ–°è¯ä¹¦ï¼š

```bash
# é‡æ–°ç”Ÿæˆè¯ä¹¦
cd volumes/api/ssl
rm *.crt *.key
make mqtt-ssl-setup
```

## ç”Ÿäº§éƒ¨ç½²æ³¨æ„äº‹é¡¹

1. **ä½¿ç”¨æ­£å¼SSLè¯ä¹¦**: ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨Let's Encryptæˆ–å•†ä¸šSSLè¯ä¹¦
2. **å®šæœŸæ›´æ–°è¯ä¹¦**: è®¾ç½®è‡ªåŠ¨åŒ–è¯ä¹¦æ›´æ–°
3. **ç›‘æ§å’Œæ—¥å¿—**: é…ç½®é€‚å½“çš„ç›‘æ§å’Œæ—¥å¿—æ”¶é›†
4. **é˜²ç«å¢™é…ç½®**: ç¡®ä¿8883ç«¯å£åœ¨é˜²ç«å¢™ä¸­å¼€æ”¾

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿æ¥è¢«æ‹’ç»**
   ```bash
   docker ps  # æ£€æŸ¥å®¹å™¨çŠ¶æ€
   make mqtt-ssl-logs  # æŸ¥çœ‹æ—¥å¿—
   ```

2. **SSLæ¡æ‰‹å¤±è´¥**
   ```bash
   openssl s_client -connect localhost:8883  # æµ‹è¯•SSLè¿æ¥
   ```

3. **MQTTè®¤è¯å¤±è´¥**
   - ç¡®è®¤ç”¨æˆ·åå¯†ç : `admin/admin123`
   - æ£€æŸ¥RabbitMQç®¡ç†ç•Œé¢: http://localhost:15672

## ä¸åŸé…ç½®çš„å¯¹æ¯”

| æ–¹é¢ | åŸKongé…ç½® | æ–°NGINXé…ç½® |
|------|------------|-------------|
| å¤æ‚åº¦ | é«˜ï¼ˆéœ€è¦åˆå§‹åŒ–è„šæœ¬ï¼‰ | ä½ï¼ˆç›´æ¥é…ç½®ï¼‰ |
| å¯åŠ¨æ—¶é—´ | æ…¢ï¼ˆéœ€è¦ç­‰å¾…å’Œæ£€æŸ¥ï¼‰ | å¿«ï¼ˆç›´æ¥å¯åŠ¨ï¼‰ |
| ç»´æŠ¤æ€§ | å¤æ‚ | ç®€å• |
| èµ„æºå ç”¨ | é«˜ | ä½ |
| ç¨³å®šæ€§ | ä¾èµ–è„šæœ¬é€»è¾‘ | åŸç”Ÿæ”¯æŒ |

## æ€»ç»“

ç®€åŒ–åçš„MQTT SSLé…ç½®å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- âœ… **é…ç½®ç®€å•**: å»é™¤äº†å¤æ‚çš„Kongåˆå§‹åŒ–è„šæœ¬
- âœ… **ç¨³å®šå¯é **: ä½¿ç”¨NGINXåŸç”Ÿstreamæ¨¡å—ï¼Œæ— éœ€åŠ¨æ€é…ç½®
- âœ… **æ˜“äºç»´æŠ¤**: æ¸…æ™°çš„é…ç½®æ–‡ä»¶ï¼Œä¾¿äºç†è§£å’Œä¿®æ”¹
- âœ… **ç”Ÿäº§å°±ç»ª**: æ”¯æŒç°ä»£TLSåè®®å’Œå®‰å…¨é…ç½®
- âœ… **å®Œæ•´æµ‹è¯•**: è‡ªåŠ¨åŒ–æµ‹è¯•ç¡®ä¿é…ç½®æ­£ç¡®

è¿™ä¸ªé…ç½®æ»¡è¶³äº†æ‚¨çš„éœ€æ±‚ï¼šä¿æŒç®€å•ã€ç”Ÿäº§å¯ç”¨ï¼Œå¹¶ä¸”å»æ‰äº†ä¸å¿…è¦çš„å¤æ‚æ€§ã€‚
