name: scada
services:
  # FastAPI Backend Service
  api:
    container_name: scada-api
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    networks:
      - zxnet
    expose:
      - "8080"
    environment:
      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-your-super-secret-password}@db:5432/${POSTGRES_DB:-scada}
      
      # Supabase Auth Configuration
      SUPABASE_URL: ${SUPABASE_URL:-http://localhost:8080}
      SUPABASE_SERVICE_KEY: ${SERVICE_ROLE_KEY:-your-service-role-key}
      SUPABASE_ANON_KEY: ${ANON_KEY:-your-anon-key}
      SUPABASE_JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-token-with-at-least-32-characters-long}
      
      # JWT Configuration
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-token-with-at-least-32-characters-long}
      JWT_EXPIRY: ${JWT_EXPIRY:-3600}
      
      # CORS Configuration
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://localhost:8080}
      
      # Environment
      ENVIRONMENT: ${ENVIRONMENT:-development}
      DEBUG: ${DEBUG:-true}
    depends_on:
      db:
        condition: service_healthy
      auth:
        condition: service_healthy
    volumes:
      - .:/app
      - /app/__pycache__

  # Frontend UI Service
  ui:
    container_name: scada-ui
    build:
      context: ../kmfscada-ui
      dockerfile: Dockerfile
    restart: unless-stopped
    networks:
      - zxnet
    expose:
      - "3000"
    environment:
      NEXT_PUBLIC_SUPABASE_URL: ${SUPABASE_URL:-http://localhost:8080}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${ANON_KEY:-your-anon-key}
      NEXT_PUBLIC_API_URL: ${API_URL:-http://localhost:8080}
    depends_on:
      kong:
        condition: service_started
      api:
        condition: service_started

networks:
  zxnet:
    external: true