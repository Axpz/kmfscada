events {
    worker_connections 8192;
}

stream {
    error_log /var/log/nginx/error.log warn;

    upstream mqtt_backend {
        server rabbitmq:1883;   # RabbitMQ MQTT 插件明文端口
    }

    server {
        listen 8883 ssl;
        proxy_pass mqtt_backend;

        ssl_certificate /etc/nginx/ssl/mqtt.crt;
        ssl_certificate_key /etc/nginx/ssl/mqtt.key;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5:!RC4:!DES:!3DES:!EXPORT:!NULL;
        ssl_prefer_server_ciphers off;

        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_session_tickets off;

        ssl_handshake_timeout 30s;

        proxy_timeout 3600s;
        proxy_connect_timeout 10s;
        proxy_buffer_size 16k;
    }
}

http {
    server {
        listen 80;
        location /health {
            return 200 "OK";
            add_header Content-Type text/plain;
        }
    }
}
